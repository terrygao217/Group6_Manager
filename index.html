<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬å…­ç»„ | è£è€€æˆç»©ç®¡ç†ç³»ç»Ÿ V2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --accent-color: #1cc88a;
            --bg-color: #f8f9fc;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #5a5c69;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        header h1 { margin: 0; font-size: 2.2em; letter-spacing: 1px; }
        header p { margin-top: 8px; opacity: 0.9; }

        /* é¡¶éƒ¨ç®¡ç†æŒ‰é’® */
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
            transition: 0.3s;
            text-decoration: none;
            font-size: 0.9em;
        }
        .header-btn:hover { background: rgba(255,255,255,0.4); }

        .dashboard {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.85em; color: #888; }
        
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #d1d3e2;
            border-radius: 5px; box-sizing: border-box; font-size: 1em;
        }
        select.form-control { background-color: #fff; cursor: pointer; }

        .subject-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }

        .btn-submit {
            width: 100%; padding: 12px; background-color: var(--primary-color);
            color: white; border: none; border-radius: 5px; font-size: 1.1em;
            cursor: pointer; transition: background 0.3s; margin-top: 10px;
        }
        .btn-submit:hover { background-color: #2e59d9; }

        /* ç»„å‘˜ç®¡ç†åŒºåŸŸæ ·å¼ */
        #memberManagerSection {
            display: none; /* é»˜è®¤éšè— */
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .member-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .member-tag {
            background: #e3e6f0; padding: 5px 12px; border-radius: 15px;
            display: flex; align-items: center; gap: 8px; font-size: 0.9em;
        }
        .member-tag span { cursor: pointer; color: #e74a3b; font-weight: bold; }
        .add-member-row { display: flex; gap: 10px; margin-top: 10px; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #e3e6f0; }
        th { background-color: #f8f9fc; color: var(--primary-color); }
        .btn-delete { background: #e74a3b; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; }

        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç¬¬å…­ç»„ Â· æˆç»©ç®¡ç†ä¸­å¿ƒ</h1>
        <p>Group 6 Leader System | é«˜æ•ˆ Â· æ™ºèƒ½ Â· è£è€€</p>
        <button class="header-btn" onclick="toggleMemberManager()">ğŸ‘¥ ç®¡ç†ç»„å‘˜åå•</button>
    </header>

    <div id="memberManagerSection" class="container">
        <h3 style="margin-top:0; color:var(--primary-color)">ç»„å‘˜åå†Œç®¡ç†</h3>
        <p style="font-size:0.9em; color:#666">è¯·åœ¨æ­¤æ·»åŠ ç¬¬å…­ç»„çš„æ‰€æœ‰æˆå‘˜ï¼Œæ·»åŠ åå½•å…¥æˆç»©æ—¶å¯ç›´æ¥é€‰æ‹©ã€‚</p>
        
        <div class="member-tags" id="memberListDisplay">
            </div>

        <div class="add-member-row">
            <input type="text" id="newMemberName" class="form-control" placeholder="è¾“å…¥æ–°ç»„å‘˜åå­—" style="width: 200px;">
            <button onclick="addMember()" class="btn-submit" style="width: auto; margin: 0; background: var(--accent-color);">+ æ·»åŠ </button>
        </div>
    </div>

    <div class="dashboard">
        <div class="input-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“ æˆç»©å½•å…¥</span>
                </div>
                <form id="scoreForm">
                    <div class="form-group">
                        <label>é€‰æ‹©ç»„å‘˜</label>
                        <select id="memberSelect" class="form-control" required>
                            <option value="" disabled selected>-- è¯·ç‚¹å‡»ä¸Šæ–¹"ç®¡ç†ç»„å‘˜åå•"æ·»åŠ  --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>è€ƒè¯•æ—¥æœŸ / æ‰¹æ¬¡</label>
                        <input type="date" id="examDate" class="form-control" required>
                    </div>
                    
                    <div class="subject-grid">
                        <div class="form-group"><label>è¯­æ–‡</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>æ•°å­¦</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>è‹±è¯­</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>ç‰©ç†</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>åŒ–å­¦</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>ç”Ÿç‰©</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>æ”¿æ²»</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>å†å²</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                        <div class="form-group"><label>åœ°ç†</label><input type="number" step="0.5" class="form-control score-input" placeholder="0"></div>
                    </div>

                    <button type="submit" class="btn-submit">ä¿å­˜å¹¶åˆ†æ</button>
                </form>
            </div>
        </div>

        <div class="display-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“š å†å²æˆç»©æ¡£æ¡ˆ</span>
                    <button class="btn-delete" style="background:#888" onclick="clearAllData()">é‡ç½®ç³»ç»Ÿ</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>ç»„å‘˜</th>
                                <th>æ—¥æœŸ</th>
                                <th>æ€»å‡åˆ†</th>
                                <th>è¯­</th><th>æ•°</th><th>è‹±</th>
                                <th>ç‰©</th><th>åŒ–</th><th>ç”Ÿ</th>
                                <th>æ”¿</th><th>å²</th><th>åœ°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>ğŸ“ˆ ç»„å‘˜çŠ¶æ€åˆ†å¸ƒå›¾</span>
                </div>
                <div style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === åˆå§‹åŒ–é€»è¾‘ ===
    document.getElementById('examDate').valueAsDate = new Date();
    let members = JSON.parse(localStorage.getItem('group6_members')) || ['ç»„é•¿']; // é»˜è®¤åªæœ‰ç»„é•¿
    loadMembersUI();
    loadData();

    // === ç»„å‘˜ç®¡ç†åŠŸèƒ½ ===
    function toggleMemberManager() {
        const section = document.getElementById('memberManagerSection');
        if (section.style.display === 'none' || section.style.display === '') {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }
    }

    function addMember() {
        const nameInput = document.getElementById('newMemberName');
        const name = nameInput.value.trim();
        if (name && !members.includes(name)) {
            members.push(name);
            saveMembers();
            nameInput.value = '';
            Swal.fire({
                toast: true, position: 'top-end', icon: 'success', 
                title: 'ç»„å‘˜å·²æ·»åŠ ', showConfirmButton: false, timer: 1500
            });
        } else if (members.includes(name)) {
            Swal.fire('æç¤º', 'è¯¥ç»„å‘˜å·²å­˜åœ¨', 'info');
        }
    }

    function removeMember(name) {
        Swal.fire({
            title: `åˆ é™¤ ${name}?`,
            text: "è¿™å°†ä»åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä½†ä¸ä¼šåˆ é™¤è¯¥ç»„å‘˜å·²å½•å…¥çš„å†å²æˆç»©ã€‚",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74a3b',
            confirmButtonText: 'ç§»é™¤'
        }).then((result) => {
            if (result.isConfirmed) {
                members = members.filter(m => m !== name);
                saveMembers();
            }
        })
    }

    function saveMembers() {
        localStorage.setItem('group6_members', JSON.stringify(members));
        loadMembersUI();
    }

    function loadMembersUI() {
        // æ›´æ–°æ ‡ç­¾åˆ—è¡¨
        const listDisplay = document.getElementById('memberListDisplay');
        listDisplay.innerHTML = members.map(m => `
            <div class="member-tag">${m} <span onclick="removeMember('${m}')">Ã—</span></div>
        `).join('');

        // æ›´æ–°ä¸‹æ‹‰èœå•
        const select = document.getElementById('memberSelect');
        if (members.length === 0) {
            select.innerHTML = '<option value="" disabled selected>è¯·å…ˆæ·»åŠ ç»„å‘˜</option>';
        } else {
            select.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            // å°è¯•ä¿æŒä¸Šæ¬¡é€‰æ‹©
            const lastSelected = localStorage.getItem('last_selected_member');
            if(lastSelected && members.includes(lastSelected)) {
                select.value = lastSelected;
            }
        }
    }

    // === æˆç»©æ ¸å¿ƒé€»è¾‘ ===
    document.getElementById('scoreForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveEntry();
    });

    function saveEntry() {
        const memberName = document.getElementById('memberSelect').value;
        if (!memberName) {
            Swal.fire('å“å‘€', 'è¯·å…ˆé€‰æ‹©è¿™å¥—æˆç»©å±äºå“ªä½ç»„å‘˜ï¼', 'error');
            return;
        }
        // è®°ä½è¿™æ¬¡é€‰çš„äººï¼Œæ–¹ä¾¿è¿ç»­å½•å…¥
        localStorage.setItem('last_selected_member', memberName);

        const date = document.getElementById('examDate').value;
        const inputs = document.querySelectorAll('.score-input');
        let total = 0;
        let scores = [];

        inputs.forEach(input => {
            let val = parseFloat(input.value);
            if (isNaN(val)) val = 0;
            scores.push(val);
            total += val;
        });

        const average = (total / 9).toFixed(2);
        
        const newEntry = {
            id: Date.now(),
            member: memberName,
            date: date,
            scores: scores,
            average: parseFloat(average)
        };

        // è¯»å–å†å²
        let history = JSON.parse(localStorage.getItem('group6_scores')) || [];
        
        // --- æ™ºèƒ½è¿›æ­¥åˆ†æ (åªè·Ÿè‡ªå·±æ¯”) ---
        // æ‰¾åˆ°è¯¥ç»„å‘˜ä¸Šä¸€æ¬¡çš„è®°å½•
        const memberHistory = history.filter(h => h.member === memberName);
        
        if (memberHistory.length > 0) {
            // æŒ‰æ—¥æœŸæ’åºæ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡
            memberHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
            const lastEntry = memberHistory[memberHistory.length - 1];
            
            if (newEntry.average > lastEntry.average) {
                const diff = (newEntry.average - lastEntry.average).toFixed(2);
                showSuccess(`${memberName} è¿›æ­¥æ˜æ˜¾ï¼\næ¯”ä¸Šæ¬¡å‡åˆ†æé«˜äº† ${diff} åˆ†ï¼ğŸš€`);
            } else if (newEntry.average < lastEntry.average) {
                Swal.fire({
                    title: 'çŠ¶æ€èµ·ä¼',
                    text: `${memberName} æ­¤æ¬¡å‡åˆ†ä¸‹æ»‘ï¼Œè¯·ç»„é•¿å…³æ³¨ã€‚`,
                    icon: 'info',
                    confirmButtonColor: '#4e73df'
                });
            } else {
                Swal.fire('å‘æŒ¥ç¨³å®š', `${memberName} æˆç»©ä¿æŒå¹³ç¨³ã€‚`, 'success');
            }
        } else {
            Swal.fire('å½•å…¥æˆåŠŸ', `å·²å»ºç«‹ ${memberName} çš„é¦–ä¸ªæˆç»©æ¡£æ¡ˆï¼`, 'success');
        }

        history.push(newEntry);
        // ä¿å­˜æ—¶æŒ‰æ—¥æœŸæ€»æ’åº
        history.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        localStorage.setItem('group6_scores', JSON.stringify(history));

        // é‡ç½®åˆ†æ•°æ¡†ï¼Œä½†ä¿ç•™åå­—å’Œæ—¥æœŸï¼Œæ–¹ä¾¿è¿ç»­å½•å…¥åŒä¸€æ¬¡è€ƒè¯•çš„å…¶ä»–ç»„å‘˜
        inputs.forEach(input => input.value = '');
        loadData();
    }

    function loadData() {
        const history = JSON.parse(localStorage.getItem('group6_scores')) || [];
        renderTable(history);
        renderChart(history);
    }

    function renderTable(data) {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        [...data].reverse().forEach(entry => {
            const tr = document.createElement('tr');
            let scoresHtml = '';
            entry.scores.forEach(s => scoresHtml += `<td>${s}</td>`);

            tr.innerHTML = `
                <td style="font-weight:bold; color:#4e73df">${entry.member}</td>
                <td>${entry.date}</td>
                <td style="font-weight:bold;">${entry.average}</td>
                ${scoresHtml}
                <td><button class="btn-delete" onclick="deleteEntry(${entry.id})">Ã—</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function deleteEntry(id) {
        Swal.fire({
            title: 'åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74a3b',
            confirmButtonText: 'åˆ é™¤'
        }).then((result) => {
            if (result.isConfirmed) {
                let history = JSON.parse(localStorage.getItem('group6_scores')) || [];
                history = history.filter(item => item.id !== id);
                localStorage.setItem('group6_scores', JSON.stringify(history));
                loadData();
            }
        });
    }

    function clearAllData() {
        Swal.fire({
            title: 'ç¡®å®šé‡ç½®æ•´ä¸ªç³»ç»Ÿï¼Ÿ',
            text: "æ‰€æœ‰ç»„å‘˜æˆç»©å’Œåå•éƒ½å°†æ¸…ç©ºï¼",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74a3b',
            confirmButtonText: 'ç¡®è®¤æ¸…ç©º'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.removeItem('group6_scores');
                localStorage.removeItem('group6_members');
                location.reload();
            }
        });
    }

    function showSuccess(msg) {
        Swal.fire({
            title: 'Good Job! ğŸ‰',
            text: msg,
            icon: 'success',
            backdrop: `rgba(0,0,123,0.4) url("https://media.giphy.com/media/26tOZ42Mg6pbTUPVS/giphy.gif") left top no-repeat`,
            confirmButtonColor: '#1cc88a'
        });
    }

    let chartInstance = null;
    function renderChart(data) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        // æˆ‘ä»¬åªå–æœ€è¿‘çš„20æ¡æ•°æ®å±•ç¤ºï¼Œé¿å…å›¾è¡¨å¤ªæŒ¤
        const recentData = data.slice(-20);
        
        const labels = recentData.map(item => `${item.member} (${item.date.slice(5)})`);
        const scores = recentData.map(item => item.average);

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar', // æ”¹ç”¨æŸ±çŠ¶å›¾ï¼Œé€‚åˆå±•ç¤ºä¸åŒäººçš„åˆ†æ•°
            data: {
                labels: labels,
                datasets: [{
                    label: 'æ€»å¹³å‡åˆ†',
                    data: scores,
                    backgroundColor: 'rgba(78, 115, 223, 0.6)',
                    borderColor: '#4e73df',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, min: 0 } // æ ¹æ®åˆ†æ•°è°ƒæ•´
                }
            }
        });
    }
</script>

</body>
</html>
