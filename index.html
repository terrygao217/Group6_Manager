<!DOCTYPE html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬å…­ç»„ | å•ç§‘æˆç»©æ¡£æ¡ˆç³»ç»Ÿ V3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #3b5998; /* æ·±è“ï¼šä¸“ä¸šã€ç¨³é‡ */
            --secondary-color: #f0f2f5; /* æµ…ç°ï¼šèƒŒæ™¯ */
            --accent-color: #42b72a;  /* ç»¿è‰²ï¼šç§¯æã€è¿›æ­¥ */
            --danger-color: #ff385c;  /* çº¢è‰²ï¼šè­¦å‘Š */
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            background-color: var(--secondary-color);
            margin: 0;
            padding: 20px 0;
            color: #1c1e21;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 0 15px; }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, #4e73df 0%, #2e59d9 100%);
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        header h1 { margin: 0; font-size: 2.8em; letter-spacing: 1px; }
        header p { margin-top: 5px; opacity: 0.8; font-size: 1.1em; }

        /* é¡¶éƒ¨ç®¡ç†æŒ‰é’® */
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
            transition: 0.3s;
            text-decoration: none;
            font-size: 0.9em;
        }
        .header-btn:hover { background: rgba(255,255,255,0.4); }

        .content-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #606770; font-weight: 500;}
        
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #ccd0d5;
            border-radius: 6px; box-sizing: border-box; font-size: 1em;
            transition: border-color 0.3s;
        }
        .form-control:focus { border-color: var(--primary-color); outline: none; }
        select.form-control { background-color: #fff; cursor: pointer; }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .btn-submit {
            width: 100%; padding: 12px; background-color: var(--primary-color);
            color: white; border: none; border-radius: 6px; font-size: 1.1em;
            cursor: pointer; transition: background 0.3s; margin-top: 10px;
            font-weight: 600;
        }
        .btn-submit:hover { background-color: #29487d; }

        /* ç»„å‘˜ç®¡ç†æ ·å¼ (æ²¿ç”¨ V2.0 é€»è¾‘) */
        #memberManagerSection {
            display: none; background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px;
            border-left: 5px solid var(--accent-color); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .member-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .member-tag { background: #e4e6eb; padding: 5px 12px; border-radius: 16px; font-size: 0.9em; display: flex; align-items: center; }
        .member-tag span { cursor: pointer; color: var(--danger-color); font-weight: bold; margin-left: 5px; }
        .add-member-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn-add { background: var(--accent-color) !important; margin:0 !important; }

        /* ç­›é€‰åŒºæ ·å¼ */
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #f0f2f5; }
        th { background-color: #f7f7f7; color: var(--primary-color); font-weight: 600; }
        tr:hover { background-color: #fcfcfc; }
        .btn-delete { background: var(--danger-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }

        @media (max-width: 900px) { .content-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <button class="header-btn" onclick="toggleMemberManager()">ğŸ‘¥ ç®¡ç†ç»„å‘˜åå•</button>
        <h1>ç¬¬å…­ç»„ Â· å•ç§‘æˆç»©æ¡£æ¡ˆç³»ç»Ÿ</h1>
        <p>V3.0 ä¸“æ³¨ä¸ªä½“è¿›æ­¥ Â· ç²¾å‡†å­¦ç§‘ç®¡ç†</p>
    </header>

    <div id="memberManagerSection" class="container">
        <h3 style="margin-top:0; color:var(--primary-color)">ç»„å‘˜åå†Œç®¡ç†</h3>
        <div class="member-tags" id="memberListDisplay"></div>
        <div class="add-member-row">
            <input type="text" id="newMemberName" class="form-control" placeholder="è¾“å…¥æ–°ç»„å‘˜åå­—">
            <button onclick="addMember()" class="btn-submit btn-add" style="width: 100px;">+ æ·»åŠ </button>
        </div>
    </div>
    
    <div class="content-grid">
        <div class="input-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“ å•ç§‘æˆç»©å½•å…¥</span>
                </div>
                <form id="scoreForm">
                    <div class="form-group">
                        <label>é€‰æ‹©ç»„å‘˜</label>
                        <select id="memberSelect" class="form-control" required></select>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label>è€ƒè¯•æ—¥æœŸ</label>
                            <input type="date" id="examDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>é€‰æ‹©ç§‘ç›®</label>
                            <select id="subjectSelect" class="form-control" required></select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>å•ç§‘åˆ†æ•°</label>
                        <input type="number" step="0.5" id="scoreInput" class="form-control" placeholder="è¯·è¾“å…¥æœ¬æ¬¡åˆ†æ•° (0-150)" required>
                    </div>

                    <button type="submit" class="btn-submit">ä¿å­˜å¹¶åˆ†æ</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>ğŸ” æ•°æ®ç­›é€‰</span>
                </div>
                <div class="filter-grid">
                     <div class="form-group">
                        <label>æŒ‰ç»„å‘˜ç­›é€‰</label>
                        <select id="filterMemberSelect" class="form-control" onchange="loadData(true)"></select>
                    </div>
                    <div class="form-group">
                        <label>æŒ‰ç§‘ç›®ç­›é€‰</label>
                        <select id="filterSubjectSelect" class="form-control" onchange="loadData(true)"></select>
                    </div>
                </div>
            </div>
        </div>

        <div class="display-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“š å†å²æˆç»©æ¡£æ¡ˆ</span>
                    <button class="btn-delete" onclick="clearAllData()">é‡ç½®ç³»ç»Ÿ</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>ç»„å‘˜</th>
                                <th>æ—¥æœŸ</th>
                                <th>ç§‘ç›®</th>
                                <th>åˆ†æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>ğŸ“ˆ æˆç»©èµ°åŠ¿å›¾</span>
                    <small style="color:#606770">å½“å‰ç­›é€‰ï¼š<span id="currentFilterDisplay">å…¨éƒ¨è®°å½•</span></small>
                </div>
                <div style="height: 350px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === é…ç½®å’Œåˆå§‹åŒ– ===
    const SUBJECTS = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'å†å²', 'åœ°ç†'];
    let chartInstance = null;

    document.getElementById('examDate').valueAsDate = new Date();
    let members = JSON.parse(localStorage.getItem('group6_members')) || ['ç»„é•¿']; 

    document.addEventListener('DOMContentLoaded', initializeSystem);

    function initializeSystem() {
        loadMembersUI();
        populateSubjectDropdowns();
        loadData();
    }

    // === ç»„å‘˜å’Œç§‘ç›®ä¸‹æ‹‰èœå•åŠ è½½ ===
    function populateSubjectDropdowns() {
        const inputSelect = document.getElementById('subjectSelect');
        const filterSelect = document.getElementById('filterSubjectSelect');

        // Populate Input Select
        inputSelect.innerHTML = SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('');

        // Populate Filter Select (add 'å…¨éƒ¨ç§‘ç›®' option)
        filterSelect.innerHTML = `<option value="">å…¨éƒ¨ç§‘ç›®</option>` + SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function loadMembersUI() {
        // ç»„å‘˜ç®¡ç†é¢æ¿æ¸²æŸ“
        const listDisplay = document.getElementById('memberListDisplay');
        listDisplay.innerHTML = members.map(m => `
            <div class="member-tag">${m} <span onclick="removeMember('${m}')">Ã—</span></div>
        `).join('');

        // æˆç»©å½•å…¥ Select
        const memberSelect = document.getElementById('memberSelect');
        const filterMemberSelect = document.getElementById('filterMemberSelect');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç»„å‘˜
        if (members.length === 0) {
            memberSelect.innerHTML = '<option value="" disabled selected>è¯·å…ˆæ·»åŠ ç»„å‘˜</option>';
            filterMemberSelect.innerHTML = '<option value="">å…¨éƒ¨ç»„å‘˜</option>';
        } else {
            memberSelect.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
            filterMemberSelect.innerHTML = `<option value="">å…¨éƒ¨ç»„å‘˜</option>` + members.map(m => `<option value="${m}">${m}</option>`).join('');

            // ä¿æŒä¸Šæ¬¡é€‰æ‹©
            const lastSelected = localStorage.getItem('last_selected_member');
            if(lastSelected && members.includes(lastSelected)) {
                memberSelect.value = lastSelected;
            }
        }
    }

    // (ç»„å‘˜ç®¡ç†å¢åˆ æ”¹æŸ¥å‡½æ•° - ä¿æŒ V2.0 é€»è¾‘)
    function toggleMemberManager() {
        const section = document.getElementById('memberManagerSection');
        section.style.display = (section.style.display === 'none' || section.style.display === '') ? 'block' : 'none';
    }

    function addMember() {
        const nameInput = document.getElementById('newMemberName');
        const name = nameInput.value.trim();
        if (name && !members.includes(name)) {
            members.push(name);
            saveMembers();
            nameInput.value = '';
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ç»„å‘˜å·²æ·»åŠ ', showConfirmButton: false, timer: 1500 });
        } else if (members.includes(name)) {
            Swal.fire('æç¤º', 'è¯¥ç»„å‘˜å·²å­˜åœ¨', 'info');
        }
    }

    function removeMember(name) {
        Swal.fire({
            title: `åˆ é™¤ ${name}?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#ff385c', confirmButtonText: 'ç§»é™¤'
        }).then((result) => {
            if (result.isConfirmed) {
                members = members.filter(m => m !== name);
                saveMembers();
            }
        });
    }

    function saveMembers() {
        localStorage.setItem('group6_members', JSON.stringify(members));
        loadMembersUI();
        loadData(true); // åˆ·æ–°æ•°æ®ä»¥ä¾¿ç­›é€‰å™¨æ›´æ–°
    }

    // === æˆç»©å½•å…¥å’Œè¿›æ­¥åˆ†æ (æ ¸å¿ƒé€»è¾‘) ===
    document.getElementById('scoreForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveEntry();
    });

    function saveEntry() {
        const memberName = document.getElementById('memberSelect').value;
        const subject = document.getElementById('subjectSelect').value;
        const date = document.getElementById('examDate').value;
        const score = parseFloat(document.getElementById('scoreInput').value);

        if (!memberName || !subject || isNaN(score)) {
            Swal.fire('è¾“å…¥é”™è¯¯', 'è¯·ç¡®ä¿æ‰€æœ‰å­—æ®µéƒ½å·²å¡«å†™', 'error');
            return;
        }

        // è®°ä½è¿™æ¬¡é€‰çš„äºº
        localStorage.setItem('last_selected_member', memberName);
        
        const newEntry = {
            id: Date.now(),
            member: memberName,
            date: date,
            subject: subject,
            score: score
        };

        let history = JSON.parse(localStorage.getItem('group6_scores')) || [];
        
        // --- V3.0 æ™ºèƒ½è¿›æ­¥åˆ†æ (åªå¯¹æ¯”è¯¥ç»„å‘˜çš„è¯¥ç§‘ç›®å†å²æˆç»©) ---
        const memberSubjectHistory = history
            .filter(h => h.member === memberName && h.subject === subject)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if (memberSubjectHistory.length > 0) {
            const lastEntry = memberSubjectHistory[memberSubjectHistory.length - 1];
            
            if (newEntry.score > lastEntry.score) {
                const diff = (newEntry.score - lastEntry.score).toFixed(1);
                showSuccess(`**${memberName}çš„${subject}** è¿›æ­¥æ˜æ˜¾ï¼\næ¯”ä¸Šæ¬¡æé«˜äº† ${diff} åˆ†ï¼ğŸš€`);
            } else if (newEntry.score < lastEntry.score) {
                Swal.fire({
                    title: 'çŠ¶æ€è­¦æŠ¥',
                    text: `${memberName}çš„${subject} åˆ†æ•°ä¸‹æ»‘ï¼Œè¯·ç»„é•¿åˆ†æåŸå› ã€‚`,
                    icon: 'info',
                    confirmButtonColor: '#3b5998'
                });
            } else {
                Swal.fire('å‘æŒ¥ç¨³å®š', `${memberName}çš„${subject} æˆç»©ä¿æŒå¹³ç¨³ã€‚`, 'success');
            }
        } else {
            Swal.fire('é¦–ä¸ªè®°å½•', `å·²å»ºç«‹ ${memberName} çš„ ${subject} æˆç»©æ¡£æ¡ˆï¼`, 'success');
        }

        history.push(newEntry);
        // ä¿å­˜å¹¶åˆ·æ–°
        localStorage.setItem('group6_scores', JSON.stringify(history));

        // é‡ç½®åˆ†æ•°æ¡†
        document.getElementById('scoreInput').value = '';
        loadData(true);
    }

    // === æ•°æ®å±•ç¤ºå’Œç­›é€‰ ===
    function loadData(useFilters = false) {
        let history = JSON.parse(localStorage.getItem('group6_scores')) || [];
        
        const filterMember = document.getElementById('filterMemberSelect').value;
        const filterSubject = document.getElementById('filterSubjectSelect').value;
        let filteredData = history;

        // åº”ç”¨ç­›é€‰
        if (filterMember) {
            filteredData = filteredData.filter(e => e.member === filterMember);
        }
        if (filterSubject) {
            filteredData = filteredData.filter(e => e.subject === filterSubject);
        }

        // æ›´æ–°ç­›é€‰æ˜¾ç¤º
        let filterDisplay = 'å…¨éƒ¨è®°å½•';
        if (filterMember && filterSubject) {
            filterDisplay = `${filterMember} çš„ ${filterSubject} æˆç»©`;
        } else if (filterMember) {
            filterDisplay = `${filterMember} çš„å…¨éƒ¨æˆç»©`;
        } else if (filterSubject) {
            filterDisplay = `æ‰€æœ‰ç»„å‘˜çš„ ${filterSubject} æˆç»©`;
        }
        document.getElementById('currentFilterDisplay').textContent = filterDisplay;

        // æŒ‰æ—¥æœŸæ’åº (ç”¨äºå›¾è¡¨)
        filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));

        renderTable(filteredData);
        renderChart(filteredData);
    }

    function renderTable(data) {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        // å€’åºæ˜¾ç¤ºï¼Œæœ€è¿‘çš„åœ¨ä¸Šé¢
        [...data].reverse().forEach(entry => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:600; color:#3b5998">${entry.member}</td>
                <td>${entry.date}</td>
                <td>${entry.subject}</td>
                <td style="font-weight:700; color:${entry.score < 60 ? var(--danger-color) : var(--primary-color)}">${entry.score}</td>
                <td><button class="btn-delete" onclick="deleteEntry(${entry.id})">åˆ é™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        // xè½´æ ‡ç­¾ï¼šæ—¥æœŸ + æˆå‘˜/ç§‘ç›®
        const labels = data.map(item => `${item.date} (${item.member || item.subject})`);
        const scores = data.map(item => item.score);
        
        const color = document.getElementById('filterSubjectSelect').value ? '#ff7e36' : '#3b5998'; // æœ‰ç­›é€‰åˆ™å˜è‰²

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line', 
            data: {
                labels: labels,
                datasets: [{
                    label: document.getElementById('currentFilterDisplay').textContent,
                    data: scores,
                    borderColor: color,
                    backgroundColor: 'rgba(59, 89, 152, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: color,
                    pointRadius: 4,
                    fill: true,
                    tension: 0.2 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false, min: Math.max(0, Math.min(...scores) - 10) },
                    x: { ticks: { maxRotation: 45, minRotation: 45 } }
                }
            }
        });
    }
    
    // (åˆ é™¤å’Œæ¸…ç©ºå‡½æ•° - ä¿æŒ V2.0 é€»è¾‘)
    function deleteEntry(id) {
        Swal.fire({
            title: 'åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ff385c', confirmButtonText: 'åˆ é™¤'
        }).then((result) => {
            if (result.isConfirmed) {
                let history = JSON.parse(localStorage.getItem('group6_scores')) || [];
                history = history.filter(item => item.id !== id);
                localStorage.setItem('group6_scores', JSON.stringify(history));
                loadData(true);
            }
        });
    }

    function clearAllData() {
        Swal.fire({
            title: 'ç¡®å®šé‡ç½®æ•´ä¸ªç³»ç»Ÿï¼Ÿ', text: "æ‰€æœ‰æˆç»©å’Œåå•éƒ½å°†æ¸…ç©ºï¼", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ff385c', confirmButtonText: 'å…¨éƒ¨æ¸…ç©º'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.removeItem('group6_scores');
                localStorage.removeItem('group6_members');
                location.reload();
            }
        });
    }

    function showSuccess(msg) {
        Swal.fire({
            title: 'æ­å–œè¿›æ­¥ï¼ğŸ‰',
            html: `<p style="font-size: 1.2em;">${msg}</p>`,
            icon: 'success',
            backdrop: `rgba(0,0,123,0.4) url("https://media.giphy.com/media/26tOZ42Mg6pbTUPVS/giphy.gif") left top no-repeat`,
            confirmButtonColor: '#42b72a'
        });
    }
</script>

</body>
</html>
